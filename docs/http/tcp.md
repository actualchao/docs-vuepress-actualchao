---
title: TCP 协议
sidebarDepth: 5
---

# TCP 协议 详解

## 描述

是一种面向连接的、可靠的、传输控制协议.

TCP将用户数据打包构成报文段，它发送数据时启动一个定时器，另一端收到数据进行确认，对失序的数据重新排序，丢弃重复的数据

## 为什么要有 TCP 

TCP 协议是建立在IP 协议之上 为了解决 IP 协议无法保证可靠性的问题而提出的一种上层传输控制协议.下面是 IP 协议的描述

:::tip IP 协议的描述
IP 协议根据端到端的设计原则，IP只为主机提供一种无连接、不可靠的、尽力而为的数据包传输服务。

IP主要包含三方面内容：IP编址方案、分组封装格式及分组转发规则。

用我们的话来说,就是IP 只负责运输只一个消息,,他不会关注消息是什么,也不会关心消息是否发送到,它只负责发出去和接收.
:::


## 面向连接

TCP 主要用于上层应用层的应用程序之间的消息传递,提供的是 `端到端的字节流传输服务`,也就是源端口到目标端口的数据传输,应用程序监听着计算机端口,拿到传递的数据.

要保证信息传递的可靠性,首先就要建立连接,脑补一下打电话和发微信消息的区别,你就能领会 TCP 和 UDP 的区别.

当应用程序希望通过 TCP 与另一个应用程序通信时，它会发送一个通信请求。这个请求必须被送到一个确切网卡地址所在计算机的确切端口。在双方“握手”之后，TCP 将在两个应用程序之间建立一个全双工 (full-duplex) 的通信。

这个全双工的通信将占用两个计算机之间的通信线路，直到它被一方或双方关闭为止。

面向连接的实现就是我们常说的:
- TCP 三次握手
- 四次挥手


## 可靠性
- 应用数据会根据带宽吞吐量、另一端发送缓存区能接纳的数据量等实时情况被分成TCP认为的最合适的发送数据块(流量控制)
- 当TCP发送一个段(segment)之后，启动一个定时器，等待目的点确认收到报文，如果不能及时收到一个确认，将重发这个数据段(segment)。
- 当TCP收到连接端发来的数据，就会推迟几分之一秒发送一个确认。
- TCP将保持它首部和数据的检验和，这是一个端对端的检验和，目的在于检测数据在传输过程中是否发生变化。（有错误，就不确认，发送端就会重发）
- TCP是以IP报文来传送，IP数据是无序的，TCP收到所有数据后进行排序，再交给应用层
- 对 IP 网络层传回的数据进行去重.
- TCP对字节流不做任何解释，对字节流的解释由TCP连接的双方应用层解释。

## TCP 协议首部
TCP 协议首部定义了用于实现 TCP 协议,面向连接,可靠性所必须的一些数据标识,根据这些标识, TCP 协议完成内部的逻辑转化,将最后校验好没有问题的数据传递给上层应用程序解析.

每一层网络协议都有自己的首部,没经过一层模型,就会在数据包基础上,打上对应的首部信息.

下面是 TCP 协议首部的报文格式



![](./images/TCP_header.jpg)

### 抓包

我们通过 wireshark 抓包工具,抓去网卡上的 TCP 连接包,通过分析包的数据来对照分析上面的报文格式对应的字段功能:


<div align="center">
   <img style="width:100%;" loading="lazy"  src="./images/segment.jpg" alt="插入排序动图" />
</div>


### Source Port 源端口号

16位的源端口中包含初始化通信的端口。源端口和源IP地址的作用是标识建立连接请求的本机程序,也就是目标主机返回数据报文的地址.

### Destination Port 目标端口号

16位的目标端口中包含需要建立连接的 目标主机程序的通信端口, 用于标识要建立连接的目标主机程序,也就是当前报文发送的接收方.

### Sequence Number 序列号

32位的序列号由源主机生成, 由接收端计算机使用，当SYN 同步连接标识别出现，序列码实际上是初始序列码（Initial Sequence Number，ISN），而第一个数据字节是ISN+1。这个序列号（序列码）可用来补偿传输中的不一致。

实际上就是当前发送的 TCP Segment 数据报的序号.用于对数据报文的重组等操作.

### Acknowledgment Number 确认号

32位的序列号由源主机生成,由接收端计算机使用，如果设置了ACK控制位，这个值表示一个准备接收的包的序列码, 也就是标示这哥序列号之前的 数据报文都已经确认接收到.

### Header Length 头部长度

4位头部长度包括TCP头大小，指示何处数据开始。

### 保留位 

6位保留位,用于未来扩展.

### 标识位

6位标志域。
- URG 紧急标志

  用于

- ACK 有意义的应答标志

  用于

- PSH 推送标识

  用于
  
- RST 重置连接

  用于
  
- SYN 同步序列号

  用于
  
- FIN 结束位

  用于
  




